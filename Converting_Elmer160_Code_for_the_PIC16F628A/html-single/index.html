<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Converting Elmer160 Code for the PIC16F628A</title><link rel="stylesheet" type="text/css" href="Common_Content/css/default.css" /><link rel="stylesheet" media="print" href="Common_Content/css/print.css" type="text/css" /><meta name="generator" content="publican 2.8" /><meta name="package" content="Elmer-Converting_Elmer160_Code_for_the_PIC16F628A-160-en-US-0-0" /><meta name="description" content="How to convert the Elmer 160 code to the PIC16F628A used in the PIC-EL II and PIC-EL III" /></head><body class="draft "><p id="title"><a class="left" href="https://fedorahosted.org/publican"><img src="Common_Content/images/image_left.png" alt="Product Site" /></a><a class="right" href="https://fedorahosted.org/publican"><img src="Common_Content/images/image_right.png" alt="Documentation Site" /></a></p><div xml:lang="en-US" class="article" id="id767302" lang="en-US"><div class="titlepage"><div><div class="producttitle"><span class="productname">Elmer</span> <span class="productnumber">160</span></div><div><h1 id="id767302" class="title">Converting Elmer160 Code for the PIC16F628A</h1></div><div><h2 class="subtitle"> </h2></div><div><h3 class="corpauthor">
		<span class="inlinemediaobject"><img src="Common_Content/images/title_logo.png" /></span>

	</h3></div><div><div xml:lang="en-US" class="authorgroup" lang="en-US"><div class="author"><h3 class="author"><span class="firstname">John</span> <span class="surname">McDonough</span></h3><div class="affiliation"><span class="orgname">WB8RCR</span></div><code class="email"><a class="email" href="mailto:wb8rcr@arrl.net">wb8rcr@arrl.net</a></code></div></div></div><div><div id="id1154820" class="legalnotice"><h1 class="legalnotice">Legal Notice</h1><div class="para">
		Copyright <span class="trademark"></span>© 2011 John J. McDonough, WB8RCR. This material may only be distributed subject to the terms and conditions set forth in the Creative Commons Unported Share Alike (CC-BY-SA), V3.0 or later (the latest version is presently available at <a href="http://creativecommons.org/licenses/by-sa/3.0/">http://creativecommons.org/licenses/by-sa/3.0/</a>).
	</div></div></div><div><div class="abstract"><h6>Abstract</h6><div class="para">
			How to convert the Elmer 160 code to the PIC16F628A used in the PIC-EL II and PIC-EL III
		</div></div></div></div><hr /></div><div class="section"><div class="titlepage"><div><div><h2 class="title" id="id767312">1. Introduction</h2></div></div></div><div class="para">
			The original Elmer 160 course was written around the <span class="application"><strong>PIC16F84A</strong></span> microcontroller. Even at the time this was a somewhat controversial decision. The <span class="application"><strong>PIC16F84A</strong></span> is a relatively expensive part, and is the least capable of the 14-bit core PICs. However, this lack of capability leads to greater simplicity; something very worthwhile when learning a new subject.
		</div><div class="para">
			The American QRP Club kitted a device called the <span class="application"><strong>PIC-EL</strong></span>, designed by AA0ZZ and others, to go along with the course. Eventually, the supply of kits ran out, but demand for the kit remained high.
		</div><div class="para">
			Craig Johnson, AA0ZZ, negotiated with Kanga U.S. to distribute an updated version of the <span class="application"><strong>PIC-EL</strong></span>. Having a commercial supplier meant that there could be an almost unlimited supply for future students. The new, <span class="application"><strong>PIC-EL II</strong></span> however, used the <span class="application"><strong>PIC16F628A</strong></span> instead of the simpler <span class="application"><strong>PIC16F84A</strong></span>.
		</div><div class="para">
			There are a number of reasons to select the newer part: 
			<div class="itemizedlist"><ul><li class="listitem"><div class="para">
						It is considerably cheaper
					</div></li><li class="listitem"><div class="para">
						It has twice the memory of the older part
					</div></li><li class="listitem"><div class="para">
						It has additional, useful peripherals
					</div></li><li class="listitem"><div class="para">
						It was not clear how much longer the <span class="application"><strong>PIC16F84A</strong></span> would be available
					</div></li></ul></div>

		</div><div class="para">
			Later still the <span class="application"><strong>PIC-EL III</strong></span> was introduced, incorporating a USB programmer, but retaining the <span class="application"><strong>PIC16F628A</strong></span>. Since few modern computers have the serial port required of the earlier devices, the <span class="application"><strong>PIC-EL III</strong></span> is the tool of choice for new students. However, the lessons are written around the <span class="application"><strong>PIC16F84A</strong></span>.
		</div><div class="para">
			Since the <span class="application"><strong>PIC16F628A</strong></span> is significantly more complex than the <span class="application"><strong>PIC16F84A</strong></span>, new students are encouraged to obtain a <span class="application"><strong>PIC16F84A</strong></span> (which can be used in the newer boards) to follow the lessons. Code for using other PICs is introduced later on in the lessons, so at that point it makes sense to use the <span class="application"><strong>PIC16F628A</strong></span>. Indeed, there are quite a number of PICs that may be used in the <span class="application"><strong>PIC-EL</strong></span>, and for new designs, almost anything makes more sense than the <span class="application"><strong>PIC16F84A</strong></span>. However, the <span class="application"><strong>PIC16F84A</strong></span> is far simpler, so it is recommended for beginners.
		</div><div class="para">
			Although the <span class="application"><strong>PIC16F84A</strong></span> is significantly more expensive than the <span class="application"><strong>PIC16F628A</strong></span>, it is still fairly inexpensive. But it isn't something the student can pick up at the local hardware store, and as a result, shipping often costs several times the cost of the part. As a consequence, many students choose to continue with the <span class="application"><strong>PIC16F628A</strong></span> in spite of the problems.
		</div><div class="para">
			Fortunately, most code is transportable between the various PICs within a family. There are only a handful of changes necessary in the examples in the course. This is a bit misleading since the user may be blindsided to some issues in his own code if attempted before getting to the parts of the course that explain the differences.
		</div><div class="para">
			The basic changes required are: 
			<div class="itemizedlist"><ul><li class="listitem"><div class="para">
						There are obvious changes such as the processor name and the name of the processor include file.
					</div></li><li class="listitem"><div class="para">
						There are additional configuration fuses.
					</div></li><li class="listitem"><div class="para">
						For the absolute code examples early in the lessons, the general purpose registers start at a different address.
					</div></li><li class="listitem"><div class="para">
						In the <span class="application"><strong>PIC16F628A</strong></span> the general purpose registers are banked. In the <span class="application"><strong>PIC16F84A</strong></span>, they are not. This could lead to the student discovering that his variables have suddenly disappeared for no apparent reason. Without a debugger, this could be very hard to diagnose.
					</div></li><li class="listitem"><div class="para">
						Some special function registers appear in different banks in the two processors. This largely affects the interrupts and the EEPROM, so the student is unlikely to encounter this issue early on.
					</div></li><li class="listitem"><div class="para">
						The <span class="application"><strong>PIC16F628A</strong></span> includes a comparator which is enabled by default. If the student wishes to use the comparator pins for ordinary I/O, the comparator must be turned off.
					</div></li></ul></div>

		</div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" id="id775858">2. Obvious Changes</h2></div></div></div><div class="para">
			There are a number of obvious issues to deal with. First, perhaps most obvious, select the <span class="application"><strong>PIC16F628A</strong></span> as the processor type in <span class="application"><strong>MPLAB</strong></span>. Choose <span class="guimenuitem"><strong>Select Device ...</strong></span> from the <span class="guimenu"><strong>Configure</strong></span> menu, scroll down to the correct device. 
			<div class="figure"><div class="figure-contents"><div class="mediaobject"><img src="images/628-selectdevice.png" width="270" alt="Selecting the processor in MPLAB" /><div class="longdesc"><div class="para">
							Selecting the processor in MPLAB
						</div></div></div></div><h6>Figure 1. Selecting the processor in MPLAB</h6></div><br class="figure-break" />

		</div><div class="para">
			Next, change the processor line in the source file: 
<pre class="screen">
        processor   pic16f628a
</pre>

		</div><div class="para">
			Thirdly, change the name of the processor include file: 
<pre class="screen">
        include     "P16F628A.INC"
</pre>

		</div><div class="para">
			<div class="note"><div class="admonition_header"><h2>Case Matters</h2></div><div class="admonition"><div class="para">
					Maybe not now, but perhaps later
				</div></div></div>
			 In <span class="application"><strong>MPLAB</strong></span> 8 and earlier, the case of the include file doesn't matter. In most cases, the examples show the file name in lower case, because a number of students use <span class="application"><strong>gpasm</strong></span> which expects lower case file names. However, the more recent <span class="application"><strong>MPLAB-X</strong></span> expects upper case names. Since <span class="application"><strong>gpasm</strong></span> complains about an upper case name, but still finds it, while <span class="application"><strong>MPLAB-X</strong></span> simply fails, it is probably preferable to use upper case names for the include file.
		</div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" id="id763199">3. Configuration Fuses</h2></div></div></div><div class="para">
			The newer processor, with new features, of course includes additional configuration fuses. Some of those fuses turn out to be important. In the <span class="application"><strong>PIC16F84A</strong></span> the configuration fuse setting almost always looked like: 
<pre class="screen">
                __config        _XT_OSC &amp; _WDT_OFF &amp; _PWRTE_ON
</pre>
			 These particular settings are still generally used for the <span class="application"><strong>PIC16F628A</strong></span>. They mean:
		</div><div class="para">
			<div class="itemizedlist"><ul><li class="listitem"><div class="para">
						<code class="code">_XT_OSC</code> - Use a crystal between 4 and 10 MHz.
					</div></li><li class="listitem"><div class="para">
						<code class="code">_WDT_OFF</code> - Don't use the watchdog timer. The watchdog timer creates an interrupt at a specific interval so if code hangs we could program a recovery. Since we don't have the code to handle this, we don't want an interrupt occurring every few minutes.
					</div></li><li class="listitem"><div class="para">
						<code class="code">_PWRTE_ON</code> - Turn on the power up timer. This one isn't terribly important in most cases. it simple inserts a small delay before the program starts so that any circuitry that may need a little time to stabilize before processing can do so.
					</div></li></ul></div>

		</div><div class="para">
			However, the <span class="application"><strong>PIC16F628A</strong></span> has a few other settings, some important, some not so much.
		</div><div class="para">
			<div class="itemizedlist"><ul><li class="listitem"><div class="para">
						<code class="code">_LVP_OFF</code> - This one is quite important since normally it should be OFF but the default is ON. If this bit is set to <code class="code">_LVP_ON</code> (or omitted), then should pin 10 become high, the processor will enter programming mode. On earlier (and later) PICs, a high voltage on <code class="code">MCLR</code> was required to enter programming mode. On a few PICs introduced around the same time as the <span class="application"><strong>PIC16F628A</strong></span>, this fuse allows in the field programming with only a single power supply. However, unless the circuitry takes this into account and ensures the programming pin cannot become high at the wrong time, an improper setting can cause surprising operation.
					</div></li><li class="listitem"><div class="para">
						<code class="code">_MCLRE_ON</code> - If set OFF, this allows <code class="code">MCLR</code> to be used as an input instead of processor reset. Since the <span class="application"><strong>PIC-EL</strong></span> is not wired this way, in most cases the student will want it ON. This fuse defaults "correctly".
					</div></li><li class="listitem"><div class="para">
						<code class="code">_BOREN_OFF</code> - This fuse controls a reset on brown out (low voltage). This allows for special action to be taken in the milliseconds before loss of power. In most cases of interest to students, this setting doesn't matter.
					</div></li><li class="listitem"><div class="para">
						<code class="code">_CP_OFF</code>, <code class="code">_CPD_OFF</code> - These settings control code protection. If set on, the program memory or EEPROM cannot be read by a programmer, meaning that programming cannot be verified. Typically these should both be OFF, which is the default.
					</div></li></ul></div>

		</div><div class="para">
			So, in most cases for the <span class="application"><strong>PIC-EL</strong></span>, the settings should be: 
<pre class="screen">
                __config        _XT_OSC &amp; _WDT_OFF &amp; _PWRTE_ON &amp; _LVP_OFF &amp; _BOREN_OFF
</pre>

		</div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" id="id762338">4. General Purpose Register Address</h2></div></div></div><div class="para">
			The <span class="application"><strong>PIC16F84A</strong></span> has 18 Special Function Registers (<code class="code">SFR</code>s) with addresses from 0x00 to 0x0b in two banks. The <span class="application"><strong>PIC16F628A</strong></span> has 33 Special Function Registers with addresses fro 0x00 to 0x1f. In the <span class="application"><strong>PIC16F84A</strong></span> the General Purpose Registers (<code class="code">GPR</code>s) start at 0x0c. Since that space is taken on the <span class="application"><strong>PIC16F628A</strong></span> by SFRs, the GPRs don't start until 0x20.
		</div><div class="para">
			When writing absolute code, (Lessons 15 and earlier) the assembler cannot "allocate" GPR memory. It is up to the programmer to keep track of memory use. In most cases this is done by assigning specific addresses for storage of each variable. For example, In lesson 4 there is code like: 
<pre class="screen">
; Variable Storage

Spot1   equ          H'30'   ; First program variable
Spot2   equ          H'31'   ; Second program variable
</pre>

		</div><div class="para">
			To convert a program from the <span class="application"><strong>PIC16F84A</strong></span> to the <span class="application"><strong>PIC16F628A</strong></span> it is necessary to modify each of those equivalences to ensure they are in the GPR region of memory for the target processor.
		</div><div class="para">
			If the student is unfamiliar with the program being ported, this can be problematic as there are many other uses of the <code class="code">equ</code> statement, and the developer must understand each use to decide the correct action. This operation can be highly error prone.
		</div><div class="para">
			The assembler provides a <code class="code">cblock</code> directive which creates sequential <code class="code">equ</code> statements. This allows GPRs to be "allocated" in a single place, with a single starting address. Most of the PIC Elmer code uses this method, because it makes it far easier to port programs to other processors. The programmer need only ensure that the range of the single block is within the GPR range of the target processor.
		</div><div class="para">
			Further, most of the PIC Elmer examples use few memory locations, and <code class="code">cblock</code> addresses were selected that fall in the range of all the PICs. (All the 14 bit core parts except the <span class="application"><strong>PIC16F84A</strong></span> share the 0x20 to 0x7f GPR range of the <span class="application"><strong>PIC16F628A</strong></span>.)
		</div><div class="para">
			So if the student should encounter something like: 
<pre class="screen">
                cblock          H'0c'
                        Buttons             ; Storage for inputs
                        LEDs                ; Storage for outputs
                endc
</pre>
			 it will be necessary to change the <code class="code">H'0c'</code> to some higher value, at least <code class="code">H'20'</code>, assuming the student is confident that the symbols point to GPR locations and don't have some other use.
		</div><div class="para">
			Of course, none of this matters in relocatable programs.
		</div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" id="id483358">5. Special Function Registers</h2></div></div></div><div class="para">
			The <span class="application"><strong>PIC16F628A</strong></span> has thirty-three Special Function Registers in four banks. Six of these are echoed in all banks; the same six as in the <span class="application"><strong>PIC16F84A</strong></span>.
		</div><div class="para">
			However, those registers that are not in all the banks are not always in the same banks as the <span class="application"><strong>PIC16F84A</strong></span>. Fortunately, the most commonly used registers are. <code class="code">PORTA</code>, <code class="code">TRISA</code>, <code class="code">PORTB</code> and <code class="code">TRISB</code> are all found in their familiar locations.
		</div><div class="para">
			<div class="warning"><div class="admonition_header"><h2>Warning</h2></div><div class="admonition"><div class="para">
					Here there be dragons
				</div></div></div>
			 Unfortunately, even this isn't as simple as it sounds. The <code class="code">TRIS</code> registers are in bank 1, as in the 84. But, the student is likely to put most of his data in bank 0. On the 84, data in bank 0 also appears in bank 1, but that isn't the case in the <span class="application"><strong>PIC16F628A</strong></span>. The data in bank 1 is different data than in bank 0. Typically the programmer only sets the <code class="code">TRIS</code> registers once in the program, and usually immediately switches back to bank 0. In most cases, there is no need for the data at the time the <code class="code">TRIS</code> registers are set up.
		</div><div class="para">
			Things get more interesting with the EEPROM, though. In the <span class="application"><strong>PIC16F84A</strong></span>, the <code class="code">EEDATA</code> and <code class="code">EEADR</code> registers are in bank 0, while the <code class="code">EECON1</code> and <code class="code">EECON2</code> registers are in bank 1. This works our reasonably well as the programmer generally needs access to data when dealing with <code class="code">EEDATA</code> and <code class="code">EEADR</code>, but not the others. On the <span class="application"><strong>PIC16F628A</strong></span>, however, all these registers are in bank 1. This not only means that the <code class="code">banksel</code> directives need to be moved around when converting code, the the student must be alert to where the settings are as data is manipulated.
		</div><div class="para">
			Consider the following code for the <span class="application"><strong>PIC16F84A</strong></span>: 
<pre class="screen">
Loop
        movf            Location, W     ; Location in EEPROM
        movwf           EEADR           ; Set the EEPROM address
        banksel         EECON1          ; Select bank for EECON1
        bsf             EECON1,RD       ; Initiate read
        banksel         EEDATA          ; Back to bank 0
        movf            EEDATA,W        ; Pick up the data
        movwf           Target          ; and store it off
        incf            Location,F      ; Point to next EEPROM loc
        decfsz          Index,F         ; Count down
        goto            Loop            ; Go do next location
</pre>
			 The corresponding code for the <span class="application"><strong>PIC16F628A</strong></span> has a number of differences, both in the location and targets of the <code class="code">banksel</code> directives: 
<pre class="screen">
Loop
        movf            Location, W     ; Location in EEPROM
        banksel         EEADR           ; Select bank for EE regs
        movwf           EEADR           ; Set the EEPROM address
        bsf             EECON1,RD       ; Initiate read
        movf            EEDATA,W        ; Pick up the data
        banksel         Target          ; Back to bank 0
        movwf           Target          ; and store it off
        incf            Location,F      ; Point to next EEPROM loc
        decfsz          Index,F         ; Count down
        goto            Loop            ; Go do next location
</pre>

		</div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" id="id498168">6. Comparator</h2></div></div></div><div class="para">
			On the <span class="application"><strong>PIC16F84A</strong></span>, all the pins at power up are configured as digital inputs. A couple of pins have special functions that may be enabled, but on power up, all pins are digital inputs. Students, therefore, are often surprised to see that is not the case on the <span class="application"><strong>PIC16F628A</strong></span>. <code class="code">RA0</code> through <code class="code">RA3</code> are configured for analog at power up.
		</div><div class="para">
			These pins serve as comparator inputs on the 628, and cannot be used as ordinary digital I/O until the comparator is disabled. At first glance, doing this is fairly simple: 
<pre class="screen">
      movlw     H'07'
      movwf     CMCON
</pre>

		</div><div class="para">
			Indeed, when used in the PIC-EL, this is typically all that is required for most applications.
		</div><div class="para">
			However, especially for your own applications, there is a dark side. 
			<div class="warning"><div class="admonition_header"><h2>Warning</h2></div><div class="admonition"><div class="para">
					It is possible to damage the PIC in software
				</div></div></div>

		</div><div class="para">
			PICs are extremely robust devices and can take a startling amount of abuse, but in this area of analog inputs, there is a significant risk of damaging the part.
		</div><div class="para">
			On any PIC input which may accept an analog voltage, the pin defaults to analog rather than digital. This is because an analog pin set to be a digital input and left unconnected may cause significant current to flow inside the part. This current is capable of destroying the PIC. This can also occur if the pin is set to digital and held at an intermediate voltage; i.e. neither fully true or fully false.
		</div><div class="para">
			This is not an issue on the PIC-EL because these pins are all pulled up. They will remain at the supply voltage unless pulled down by a switch or the encoder. But in any case, they cannot be left at an intermediate state on the PIC-EL.
		</div><div class="para">
			However, for other designs, the student must either ensure that the pin cannot face a high impedance, or not allow the pin to be in its digital input configuration. Setting the pin to be a digital output is an acceptable strategy, as is leaving the comparator enabled.
		</div></div><div xml:lang="en-US" class="appendix" id="appe-Converting_Elmer160_Code_for_the_PIC16F628A-Revision_History" lang="en-US"><h2 class="title">A. Revision History</h2><div class="para">
		<div class="revhistory"><table border="0" width="100%" summary="Revision history"><tr><th align="left" valign="top" colspan="3"><strong>Revision History</strong></th></tr><tr><td align="left">Revision 0,1</td><td align="left">Wed Dec 21 2011</td><td align="left"><span class="author"><span class="firstname">John</span> <span class="surname">McDonough</span></span></td></tr><tr><td align="left" colspan="3">
					<table border="0" summary="Simple list" class="simplelist"><tr><td>Initial draft</td></tr></table>

				</td></tr></table></div>

	</div></div></div></body></html>
